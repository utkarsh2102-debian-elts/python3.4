Origin: https://github.com/python/cpython/commit/436fe5a447abb69e5e5a4f453325c422af02dcaa
Last-Update: 2029-06-25
Reviewed-by: Sylvain Beucler <beuc@debian.org>

From 4cbb23f8f278fd1f71dcd5968aa0b3f0b4f3bd5d Mon Sep 17 00:00:00 2001
From: Senthil Kumaran <senthil@uthcode.com>
Date: Sat, 30 Jul 2016 23:24:16 -0700
Subject: [PATCH] Prevent HTTPoxy attack (CVE-2016-1000110)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Ignore the HTTP_PROXY variable when REQUEST_METHOD environment is set, which
indicates that the script is in CGI mode.

Issue #27568 Reported and patch contributed by RÃ©mi Rampin.
---
 Doc/howto/urllib2.rst          |  5 +++++
 Doc/library/urllib.request.rst | 13 +++++++++++++
 Lib/test/test_urllib.py        | 13 +++++++++++++
 Lib/urllib/request.py          |  7 +++++++
 Misc/NEWS                      |  4 ++++
 5 files changed, 42 insertions(+)

Index: python3.4-3.4.2/Doc/howto/urllib2.rst
===================================================================
--- python3.4-3.4.2.orig/Doc/howto/urllib2.rst
+++ python3.4-3.4.2/Doc/howto/urllib2.rst
@@ -538,6 +538,11 @@ setting up a `Basic Authentication`_ han
     through a proxy.  However, this can be enabled by extending urllib.request as
     shown in the recipe [#]_.
 
+.. note::
+
+   `HTTP_PROXY`` will be ignored if a variable ``REQUEST_METHOD`` is set; see
+   the documentation on :func:`~urllib.request.getproxies`.
+
 
 Sockets and Layers
 ==================
Index: python3.4-3.4.2/Doc/library/urllib.request.rst
===================================================================
--- python3.4-3.4.2.orig/Doc/library/urllib.request.rst
+++ python3.4-3.4.2/Doc/library/urllib.request.rst
@@ -161,6 +161,14 @@ The :mod:`urllib.request` module defines
    cannot find it, looks for proxy information from Mac OSX System
    Configuration for Mac OS X and Windows Systems Registry for Windows.
 
+   .. note::
+
+      If the environment variable ``REQUEST_METHOD`` is set, which usually
+      indicates your script is running in a CGI environment, the environment
+      variable ``HTTP_PROXY`` (uppercase ``_PROXY``) will be ignored. This is
+      because that variable can be injected by a client using the "Proxy:" HTTP
+      header. If you need to use an HTTP proxy in a CGI environment use
+      ``ProxyHandler`` explicitly.
 
 The following classes are provided:
 
@@ -270,6 +278,11 @@ The following classes are provided:
 
    To disable autodetected proxy pass an empty dictionary.
 
+   .. note::
+
+      ``HTTP_PROXY`` will be ignored if a variable ``REQUEST_METHOD`` is set;
+      see the documentation on :func:`~urllib.request.getproxies`.
+
 
 .. class:: HTTPPasswordMgr()
 
Index: python3.4-3.4.2/Lib/test/test_urllib.py
===================================================================
--- python3.4-3.4.2.orig/Lib/test/test_urllib.py
+++ python3.4-3.4.2/Lib/test/test_urllib.py
@@ -226,6 +226,19 @@ class ProxyTests(unittest.TestCase):
         self.env.set('NO_PROXY', 'localhost, anotherdomain.com, newdomain.com')
         self.assertTrue(urllib.request.proxy_bypass_environment('anotherdomain.com'))
 
+    def test_proxy_cgi_ignore(self):
+        try:
+            self.env.set('HTTP_PROXY', 'http://somewhere:3128')
+            proxies = urllib.request.getproxies_environment()
+            self.assertEqual('http://somewhere:3128', proxies['http'])
+            self.env.set('REQUEST_METHOD', 'GET')
+            proxies = urllib.request.getproxies_environment()
+            self.assertNotIn('http', proxies)
+        finally:
+            self.env.unset('REQUEST_METHOD')
+            self.env.unset('HTTP_PROXY')
+
+
 class urlopen_HttpTests(unittest.TestCase, FakeHTTPMixin, FakeFTPMixin):
     """Test urlopen() opening a fake http connection."""
 
Index: python3.4-3.4.2/Lib/urllib/request.py
===================================================================
--- python3.4-3.4.2.orig/Lib/urllib/request.py
+++ python3.4-3.4.2/Lib/urllib/request.py
@@ -2355,6 +2355,13 @@ def getproxies_environment():
         name = name.lower()
         if value and name[-6:] == '_proxy':
             proxies[name[:-6]] = value
+
+    # CVE-2016-1000110 - If we are running as CGI script, forget HTTP_PROXY
+    # (non-all-lowercase) as it may be set from the web server by a "Proxy:"
+    # header from the client
+    if 'REQUEST_METHOD' in os.environ:
+        proxies.pop('http', None)
+
     return proxies
 
 def proxy_bypass_environment(host):
